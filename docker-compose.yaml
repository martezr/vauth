version: "3.7"
services:
#  ui:
#    build: ./ui
#    ports: 
#      - "4200:4200"
#    networks:
#      - vauth-backend
  scheduler:
    build: ./scheduler
    depends_on:
      - worker
    networks:
      - vauth-message
  worker:
    build: ./worker
    depends_on:
      - nats
    networks:
      - vauth-message
      - vauth-backend
    environment:
    - VSPHERE_SERVER=grtvcenter01.grt.local
    - VSPHERE_USERNAME=vauth@vsphere.local
    - VSPHERE_PASSWORD=Hashicorp1#
    - VSPHERE_DATACENTER=GRT
  syncer:
    build: ./syncer
    depends_on:
      - nats
      - worker
    networks:
      - vauth-message
    environment:
    - VSPHERE_SERVER=grtvcenter01.grt.local
    - VSPHERE_USERNAME=vauth@vsphere.local
    - VSPHERE_PASSWORD=Hashicorp1#
    - VSPHERE_DATACENTER=GRT
  watcher:
    build: ./watcher
    depends_on:
      - nats
      - worker
    networks:
      - vauth-message
    environment:
    - VSPHERE_SERVER=grtvcenter01.grt.local
    - VSPHERE_USERNAME=vauth@vsphere.local
    - VSPHERE_PASSWORD=Hashicorp1#
    - VSPHERE_DATACENTER=GRT
  nats:
    image: nats:latest
    ports: 
      - "4222:4222"
    networks:
      - vauth-message
  backend:
    build: ./backend
    ports:
    - "443:443"
    depends_on:
      - db
      - nats
    networks:
      - vauth-backend
      - vauth-message
      - vauth-database
  db:
    image: cockroachdb/cockroach:v19.1.5
    ports:
     - "8080:8080"
    networks:
      - vauth-database
    command: ["start","--insecure"]
    secrets:
      - db_cert
      - db_key
    volumes:
      - database-volume:/cockroach/cockroach-data

secrets:
   db_cert:
     file: ./backend/cert.pem
   db_key:
     file: ./backend/key.pem

networks:
  vauth-backend:
  vauth-message:
  vauth-database:

volumes:
  database-volume: